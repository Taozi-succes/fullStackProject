# Express + Vue 全栈项目企业级部署文档

## 目录
- [1. 服务器环境准备](#1-服务器环境准备)
- [2. 数据库配置](#2-数据库配置)
- [3. 项目部署](#3-项目部署)
- [4. Nginx 配置](#4-nginx-配置)
- [5. SSL 证书配置](#5-ssl-证书配置)
- [6. 防火墙配置](#6-防火墙配置)
- [7. 监控和日志](#7-监控和日志)
- [8. 备份策略](#8-备份策略)
- [9. 性能优化](#9-性能优化)
- [10. 安全加固](#10-安全加固)
- [11. 部署脚本自动化](#11-部署脚本自动化)
- [12. 部署验证](#12-部署验证)

---

## 1. 服务器环境准备

### 1.1 更新系统
```bash
# 更新软件包列表
sudo apt update

# 升级已安装的软件包
sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop unzip
```

**说明：** 保持系统最新可以确保安全性和稳定性，基础工具为后续操作提供支持。

### 1.2 安装 Node.js
```bash
# 使用 NodeSource 官方仓库安装 Node.js 18.x LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version

# 配置 npm 镜像源（可选，提高下载速度）
npm config set registry https://registry.npmmirror.com
```

**说明：** Node.js 18.x 是当前的 LTS 版本，提供长期支持和稳定性。配置镜像源可以提高国内用户的包下载速度。

### 1.3 安装 PM2
```bash
# 全局安装 PM2
npm install -g pm2

# 验证安装
pm2 --version

# 设置 PM2 开机自启
pm2 startup
# 按照提示执行返回的命令
```

**说明：** PM2 是 Node.js 应用的进程管理器，提供自动重启、负载均衡、日志管理等功能。

### 1.4 安装 MySQL
```bash
# 安装 MySQL 服务器
sudo apt install -y mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 登录root用户
mysql -u root -p

```

```sql
# 建立远程用户须知：=============================================
# 在/etc/mysql/mysql.conf.d 的 mysqld.cnf 文件中 -- 修改下面配置值为0.0.0.0 否则 mysql只会监听本机127.0.0.0 

# bind-address		= 127.0.0.1
# mysqlx-bind-address	= 127.0.0.1
bind-address            = 0.0.0.0
mysqlx-bind-address     = 0.0.0.0

# 查看所有用户
SELECT user, host FROM mysql.user

# 创建专用远程用户（避免使用管理员账号）登录mysql   %为任意ip  通常不建议 危险最好限制为自己的电脑ip
CREATE USER 'remotehuangtao'@'%' IDENTIFIED BY 'StrongPassword123!';
-- 请将 StrongPassword123! 替换为12位以上强密码（包含大小写字母、数字、特殊符号）

# 授予最小必要权限
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE TEMPORARY TABLES, EXECUTE 
ON express_vue_app.* 
TO 'remote_app'@'%';

#  刷新权限生效
FLUSH PRIVILEGES;

# 检查用户权限
SHOW GRANTS FOR 'remotehuangtao'@'%';

# 查看用户在当前输入数据库中的权限 登录mysql
SELECT * FROM mysql.db WHERE User='remothuangtao' AND Db='express_vue_app'\G

-- 应显示下面
Grant_priv: N
Select_priv: Y
Insert_priv: Y
Update_priv: Y
Delete_priv: Y
Create_tmp_table_priv: Y
Execute_priv: Y


# 安全增强措施（可选） IP限制
-- 删除原用户
DROP USER 'remotehuangtao'@'%';

-- 创建IP限制用户（替换为您的公网IP）  只有你的公网才能访问
CREATE USER 'remotehuangtao'@'公网ip' IDENTIFIED BY 'StrongPassword123!';
GRANT ... ON express_vue_app.* TO 'remote_app'@'公网ip';

# 服务器防火墙配置
# 仅允许特定IP访问
sudo ufw allow from 123.45.67.89 to any port 3306
sudo ufw reload

# 云安全组设置
-- 在云平台控制台，添加规则：仅允许您的IP访问3306端口

```



**说明：** MySQL 是项目的主数据库，`mysql_secure_installation` 会引导你设置 root 密码、删除匿名用户等安全配置。

### 1.5 安装 Redis
```bash
# 安装 Redis
sudo apt install -y redis-server

# 启动 Redis 服务
sudo systemctl start redis-server
sudo systemctl enable redis-server

# 验证安装
redis-cli ping
```

**说明：** Redis 用于缓存和会话存储，提高应用性能。

### 1.6 安装 Nginx
```bash
# 安装 Nginx
sudo apt install -y nginx

# 启动 Nginx 服务
sudo systemctl start nginx
sudo systemctl enable nginx

# 验证安装
sudo systemctl status nginx
```

**说明：** Nginx 作为反向代理服务器，处理静态文件服务和负载均衡。

---

## 2. 数据库配置

### 2.1 MySQL 配置
```bash
# 登录 MySQL
sudo mysql -u root -p
```

```sql
-- 创建项目数据库
CREATE DATABASE express_vue_app CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用用户
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'your_strong_password';

-- 授权
GRANT ALL PRIVILEGES ON express_vue_app.* TO 'app_user'@'localhost';
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

**说明：** 创建专用数据库和用户，遵循最小权限原则，提高安全性。使用 utf8mb4 字符集支持完整的 Unicode 字符。

### 2.2 Redis 配置
```bash
# 编辑 Redis 配置文件
sudo vim /etc/redis/redis.conf
```

关键配置项：
```conf
# 设置密码
requirepass your_redis_password

# 绑定地址（仅本地访问）
bind 127.0.0.1

# 设置最大内存
maxmemory 256mb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
```

```bash
# 重启 Redis 服务
sudo systemctl restart redis-server
```

**说明：** 配置 Redis 密码和内存限制，确保安全性和稳定性。持久化配置防止数据丢失。

---

## 3. 项目部署

### 3.1 创建项目目录
```bash
# 创建应用目录
sudo mkdir -p /var/www/express-vue-app
sudo chown $USER:$USER /var/www/express-vue-app
cd /var/www/express-vue-app
```

**说明：** 使用标准的 `/var/www` 目录存放 Web 应用，设置正确的所有权。

### 3.2 克隆代码
```bash
# 克隆项目代码
git clone https://github.com/your-username/your-repo.git .

# 或者如果是私有仓库，配置 SSH 密钥后克隆
# git clone git@github.com:your-username/your-repo.git .
```

**说明：** 从 Git 仓库获取最新代码。对于私有仓库，需要配置 SSH 密钥或使用访问令牌。

### 3.3 后端部署
```bash
# 进入后端目录
cd server

# 安装依赖
npm install --production

# 复制环境配置文件
cp .env.example .env

# 编辑环境配置
vim .env
```

环境配置示例：
```env
# 数据库配置
DATABASE_URL="mysql://app_user:your_strong_password@localhost:3306/express_vue_app"

# JWT 配置
JWT_SECRET="your_jwt_secret_key_here"
JWT_EXPIRES_IN="1h"
JWT_REFRESH_EXPIRES_IN="7d"

# Redis 配置
REDIS_URL="redis://:your_redis_password@localhost:6379"

# 应用配置
PORT=3000
NODE_ENV=production

# 文件上传配置
UPLOAD_PATH="/var/www/express-vue-app/server/uploads"
MAX_FILE_SIZE=5242880
```

```bash
# 运行数据库迁移
npx prisma migrate deploy

# 生成 Prisma 客户端
npx prisma generate

# 创建上传目录
mkdir -p uploads/avatars
chmod 755 uploads/avatars
```

**说明：** 生产环境使用 `--production` 安装依赖，配置正确的数据库连接和安全密钥。

### 3.4 前端构建和部署
```bash
# 进入前端目录
cd ../v3-admin-vite

# 安装依赖
npm install

# 构建生产版本
npm run build

# 创建 Nginx 静态文件目录
sudo mkdir -p /var/www/html/express-vue-app
sudo cp -r dist/* /var/www/html/express-vue-app/
sudo chown -R www-data:www-data /var/www/html/express-vue-app
```

**说明：** 构建前端应用并部署到 Nginx 静态文件目录，设置正确的文件权限。

---

## 4. Nginx 配置

### 4.1 创建站点配置
```bash
# 创建站点配置文件
sudo vim /etc/nginx/sites-available/express-vue-app
```

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL 证书配置（稍后配置）
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    # SSL 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # 前端静态文件
    location / {
        root /var/www/html/express-vue-app;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 文件上传
    location /uploads/ {
        alias /var/www/express-vue-app/server/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }
    
    # 限制文件上传大小
    client_max_body_size 10M;
    
    # 日志配置
    access_log /var/log/nginx/express-vue-app.access.log;
    error_log /var/log/nginx/express-vue-app.error.log;
}
```

### 4.2 启用站点
```bash
# 创建软链接启用站点
sudo ln -s /etc/nginx/sites-available/express-vue-app /etc/nginx/sites-enabled/

# 删除默认站点（可选） 或者  想要移除配置 将下面default改为移除的站点配置即可
sudo rm /etc/nginx/sites-enabled/default

# 查看生效的软连接配置
ls -l /etc/nginx/sites-enabled/
-- 例如 
lrwxrwxrwx 1 root root 42 Aug  6 22:18 express-vue-app -> /etc/nginx/sites-available/express-vue-app
lrwxrwxrwx 1 root root 38 Aug  8 14:26 hellow-word -> /etc/nginx/sites-available/hellow-word


# 测试配置
sudo nginx -t

# 重新加载配置
sudo systemctl reload nginx
```

**说明：** Nginx 配置包含 HTTPS 重定向、安全头、Gzip 压缩、静态文件缓存和 API 代理等企业级功能。

---

## 5. SSL 证书配置

### 5.1 安装 Certbot
```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx
```

### 5.2 获取 SSL 证书
```bash
# 获取证书（替换为你的域名）
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 测试自动续期
sudo certbot renew --dry-run

# 以上自动获取证书并配置 失败的话采用下面dns方法来配置证书
1. 获取生成验证码
sudo certbot certonly --manual \
--preferred-challenges dns \
-d yourdomain.com -d www.yourdomain.com \
--email your@email.com \
--agree-tos

# 返回示例
Please deploy a DNS TXT record under the name:
_acme-challenge.yourdomain.com. with the following value:

Xr4vB8eL3kP9aZ2wY6tG0qJ1sF7dN5mC   

2. 添加TXT记录
主机: _acme-challenge
类型: TXT
值: Xr4vB8eL3kP9aZ2wY6tG0qJ1sF7dN5mC
TTL: 300秒

3. 等待DNS传播
dig +short TXT _acme-challenge.yourdomain.com
# 应返回: "Xr4vB8eL3kP9aZ2wY6tG0qJ1sF7dN5mC"  确认和保存的一样 尽量多等一会20分钟

4. 完成验证
# 在3步骤另一个终端测试   返回和保存的一样在终端按 Enter 继续即可获取证书 需要手动保存在nginx配置中
 
```

**说明：** Let's Encrypt 提供免费的 SSL 证书，Certbot 自动配置 Nginx 并设置自动续期。

---

## 6. 防火墙配置

```bash
# 启用 UFW 防火墙
sudo ufw enable

# 允许 SSH
sudo ufw allow ssh

# 允许 HTTP 和 HTTPS
sudo ufw allow 'Nginx Full'

# 查看防火墙状态
sudo ufw status
```

**说明：** 配置防火墙只允许必要的端口访问，提高服务器安全性。

---

## 7. 监控和日志

### 7.1 配置 PM2 监控
```bash
# 进入后端目录
cd /var/www/express-vue-app/server

# 使用 PM2 启动应用
pm2 start ecosystem.config.js --env production

# 保存 PM2 配置
pm2 save

# 查看应用状态
pm2 status
pm2 logs
pm2 monit
```

PM2 配置文件 `ecosystem.config.js`：
```javascript
module.exports = {
  apps: [{
    name: 'express-vue-app',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'development'
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: '/var/log/pm2/express-vue-app.error.log',
    out_file: '/var/log/pm2/express-vue-app.out.log',
    log_file: '/var/log/pm2/express-vue-app.combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
};
```

### 7.2 日志轮转配置
```bash
# 创建日志轮转配置
sudo vim /etc/logrotate.d/express-vue-app
```

### 7.3自动部署脚本

```bash
# 创建deploy-frontend.sh文件

#!/bin/bash

# 进入前端项目目录
cd /var/www/express-vue-app/fullStackProject/v3-admin-vite

# 拉取项目
git pull

# 安装依赖（可选）
npm install 

# 执行构建
npm run build

# 设置权限（确保Nginx可访问）
sudo chown -R www-data:www-data dist
sudo chmod -R 755 dist

echo "前端部署完成！构建产物目录: /var/www/express-vue-app/fullStackProject/v3-admin-vite/dist"


# 后端类似     注 pm2可以监听文件变化自己运行重启
```

